<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ã‚¹ãƒãƒ›ãƒ‰ãƒƒãƒˆRPG â€” ä¼šè©±æ”¹è‰¯ç‰ˆ</title>
<style>
  html,body{height:100%;margin:0;background:#071018;color:#e6f7ff;font-family:sans-serif;touch-action:none;}
  canvas{image-rendering:pixelated;border:6px solid #111;background:#073;display:block;margin:20px auto;touch-action:none;}
  #dialog{position:fixed;left:50%;transform:translateX(-50%);bottom:140px;max-width:94%;background:rgba(0,0,0,0.9);color:#fff;border:3px solid #333;padding:12px 14px;border-radius:10px;font-size:16px;display:none;transition:opacity 0.3s;}
</style>
</head>
<body>
<canvas id="game" width="480" height="384"></canvas>
<div id="dialog"></div>
<audio id="bgm" src="https://cdn.pixabay.com/download/audio/2022/03/09/audio_9d39a4f567.mp3?filename=peaceful-ambient-110624.mp3" loop autoplay></audio>

<script>
const TILE=48, WORLD_W=20, WORLD_H=15;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const bgm=document.getElementById("bgm");

const world=[
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
 [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,3,3,0,1],
 [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,3,3,0,1],
 [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
 [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
 [1,0,2,0,2,0,0,0,0,0,0,2,0,2,0,0,0,0,0,1],
 [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const player={x:10,y:7,px:10*TILE,py:7*TILE,dir:'down',moving:false,moveDir:null};
const camera={x:0,y:0};

// === NPCå®šç¾© ===
const npcs=[
  {
    x:8,y:7,px:8*TILE,py:7*TILE,dir:'down',range:2,dirH:1,
    text:[
      "ã“ã‚“ã«ã¡ã¯ã€æ—…ã®äººã€‚ã‚ˆã†ã“ãã“ã®å°ã•ãªæ‘ã¸ã€‚",
      "ã“ã®å…ˆã®æ£®ã«ã¯ã€å¤œã«ãªã‚‹ã¨é’ç™½ã„å…‰ãŒæºã‚‰ã‚ãã‚“ã ã€‚",
      "æ˜”ã¯ã€ç²¾éœŠã®é“ã€ã¨å‘¼ã°ã‚Œã¦ã„ã¦ã€è¿·ã£ãŸæ—…äººã‚’å°ã„ãŸã‚‰ã—ã„ã€‚",
      "â€¦â€¦ã§ã‚‚æœ€è¿‘ã¯ã€èª°ã‚‚ãã®å…‰ã‚’è¦‹ãªããªã£ã¦ã—ã¾ã£ãŸã‚“ã ã€‚"
    ],
    moving:true
  },
  {
    x:14,y:5,px:14*TILE,py:5*TILE,dir:'down',range:3,dirH:1,
    text:[
      "ãŠã‚„ã€è¦‹ã‹ã‘ãªã„é¡”ã ã­ã€‚ç§ã¯ã“ã®æ‘ã®é•·è€ã ã‚ˆã€‚",
      "æ˜”ã€…ã€ã“ã®å¤§åœ°ã®ä¸‹ã«ã¯ç«œãŒçœ ã£ã¦ã„ãŸã¨ã„ã†ã€‚",
      "ãã®ç«œã¯ã€æ‘äººãŒäº‰ã†ã¨ãã«ã ã‘ç›®ã‚’è¦šã¾ã™ã¨ä¼ãˆã‚‰ã‚Œã¦ã„ã‚‹ã€‚",
      "â€¦â€¦äººã®å¿ƒã®é™ã‘ã•ãŒã€ã“ã®æ‘ã‚’å®ˆã£ã¦ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œã‚“ã­ã€‚"
    ],
    moving:true
  }
];

const dialog=document.getElementById("dialog");
let activeNPC=null,dialogIndex=0,dialogVisible=false;
let cancelLock=false; // ğŸ†• ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾Œã¯å†æ¥è¿‘ã¾ã§ä¼šè©±ç¦æ­¢
let touchStartX=null,touchStartY=null,currentDir=null,isTouching=false;

function isWalkable(x,y){
  if(x<0||y<0||x>=WORLD_W||y>=WORLD_H)return false;
  if(world[y][x]===1||world[y][x]===4)return false;
  for(const npc of npcs){if(Math.round(npc.x)===x&&Math.round(npc.y)===y)return false;}
  return true;
}

/* === ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹• === */
function movePlayer(dir){
  if(player.moving)return;
  let nx=player.x,ny=player.y;
  if(dir==='up')ny--;if(dir==='down')ny++;if(dir==='left')nx--;if(dir==='right')nx++;
  if(!isWalkable(nx,ny))return;
  player.moving=true;player.dir=dir;
  const sx=player.x*TILE,sy=player.y*TILE,tx=nx*TILE,ty=ny*TILE;
  const start=performance.now(),duration=160;
  function step(){
    const t=Math.min((performance.now()-start)/duration,1);
    player.px=sx+(tx-sx)*t;
    player.py=sy+(ty-sy)*t;
    if(t<1)requestAnimationFrame(step);
    else{player.x=nx;player.y=ny;player.moving=false;}
  }
  requestAnimationFrame(step);
}

/* === ã‚«ãƒ¡ãƒ© === */
function updateCamera(){
  camera.x+=(player.px+TILE/2-480/2-camera.x)*0.2;
  camera.y+=(player.py+TILE/2-384/2-camera.y)*0.2;
}

/* === NPCå·¡å› === */
function updateNPCs(){
  for(const npc of npcs){
    if(!npc.moving) continue; // ğŸ†• ä¼šè©±ä¸­ã¯ç«‹ã¡æ­¢ã¾ã‚‹
    const nx=npc.x+npc.dirH*0.02;
    if(!isWalkable(Math.round(nx),Math.round(npc.y))){npc.dirH*=-1;continue;}
    npc.x=nx;
    npc.px=npc.x*TILE;
  }
}

/* === NPCè·é›¢ãƒã‚§ãƒƒã‚¯ === */
function checkNPCProximity(){
  let near=null;
  for(const npc of npcs){
    const dx=Math.abs(npc.x-player.x);
    const dy=Math.abs(npc.y-player.y);
    if(dx<=1&&dy<=1){near=npc;break;}
  }
  if(near!==activeNPC){
    if(near&&!cancelLock){ // ğŸ†• ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾Œã¯è¿‘ã¥ã„ã¦ã‚‚ä¼šè©±ã—ãªã„
      dialogIndex=0;
      showDialog(near.text[0]);
      fadeOutBGM();
      near.moving=false; // ğŸ†• ä¼šè©±ä¸­ã¯ç«‹ã¡æ­¢ã¾ã‚‹
    }else if(!near){
      hideDialog();
      fadeInBGM();
      if(activeNPC) activeNPC.moving=true; // ğŸ†• ä¼šè©±çµ‚äº†å¾Œã¯å†ã³å‹•ã
      cancelLock=false; // å†æ¥è¿‘ã§ãã‚‹ã‚ˆã†ã«è§£é™¤
    }
    activeNPC=near;
  }
}

/* === ä¼šè©±å‡¦ç† === */
function showDialog(text){
  dialog.style.display="block";
  dialog.textContent=text;
  dialogVisible=true;
}
function hideDialog(){
  dialog.style.display="none";
  dialogVisible=false;
}
function nextDialog(){
  if(!activeNPC)return;
  dialogIndex++;
  if(dialogIndex<activeNPC.text.length)showDialog(activeNPC.text[dialogIndex]);
  else {
    hideDialog();fadeInBGM();
    activeNPC.moving=true;
  }
}

/* === é•·æŠ¼ã—ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ« === */
let holdTimer=null;
dialog.addEventListener("touchstart",()=>{
  holdTimer=setTimeout(()=>{
    hideDialog();
    if(activeNPC){activeNPC.moving=true;}
    activeNPC=null;
    fadeInBGM();
    cancelLock=true; // ğŸ†• å†æ¥è¿‘ã¾ã§ä¼šè©±ç¦æ­¢
  },600);
});
dialog.addEventListener("touchend",()=>{
  if(holdTimer){clearTimeout(holdTimer);holdTimer=null;}
  else nextDialog();
});

/* === BGMãƒ•ã‚§ãƒ¼ãƒ‰ === */
function fadeOutBGM(){
  let v=bgm.volume;
  const fade=setInterval(()=>{
    v=Math.max(0,v-0.05);
    bgm.volume=v;
    if(v<=0)clearInterval(fade);
  },80);
}
function fadeInBGM(){
  let v=bgm.volume;
  const fade=setInterval(()=>{
    v=Math.min(1,v+0.05);
    bgm.volume=v;
    if(v>=1)clearInterval(fade);
  },80);
}

/* === ã‚¹ãƒ¯ã‚¤ãƒ—ç§»å‹• === */
canvas.addEventListener("touchstart",e=>{
  const t=e.touches[0];
  touchStartX=t.clientX;touchStartY=t.clientY;isTouching=true;
});
canvas.addEventListener("touchmove",e=>{
  if(!isTouching)return;
  const t=e.touches[0];
  const dx=t.clientX-touchStartX,dy=t.clientY-touchStartY;
  let dir=null;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>20)dir='right';else if(dx<-20)dir='left';
  }else{
    if(dy>20)dir='down';else if(dy<-20)dir='up';
  }
  if(dir&&dir!==currentDir){currentDir=dir;movePlayer(dir);}
});
canvas.addEventListener("touchend",()=>{isTouching=false;currentDir=null;});

/* === æç”» === */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<WORLD_H;y++)for(let x=0;x<WORLD_W;x++){
    const t=world[y][x];
    ctx.fillStyle=t===1?'#2b4f2b':t===2?'#c9a36e':t===3?'#7aa8c2':t===4?'#2a9':'#3a8a3a';
    ctx.fillRect(x*TILE-camera.x,y*TILE-camera.y,TILE,TILE);
  }
  for(const npc of npcs){
    ctx.fillStyle="#ff5";
    ctx.fillRect(npc.px-camera.x+4,npc.py-camera.y+4,TILE-8,TILE-8);
  }
  ctx.fillStyle="#66f";
  ctx.fillRect(player.px-camera.x+6,player.py-camera.y+6,TILE-12,TILE-12);
}

/* === ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— === */
function loop(){
  updateCamera();
  if(!player.moving&&isTouching&&currentDir)movePlayer(currentDir);
  updateNPCs();
  checkNPCProximity();
  render();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
