<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport"
  content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>スマホドットRPG — 龍のうろこ編</title>
<style>
  html,body{
    height:100%;margin:0;
    background:#071018;color:#e6f7ff;
    font-family:sans-serif;
    touch-action:none;
    overscroll-behavior:none;
  }
  canvas{
    image-rendering:pixelated;
    border:6px solid #111;
    background:#073;
    display:block;
    margin:20px auto;
    touch-action:none;
  }
  #dialog{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:140px;
    max-width:94%;
    background:rgba(0,0,0,0.9);
    color:#fff;
    border:3px solid #333;
    padding:12px 14px;
    border-radius:10px;
    font-size:16px;
    display:none;
    transition:opacity 0.3s;
  }
</style>
</head>
<body>
<canvas id="game" width="480" height="384"></canvas>
<div id="dialog"></div>

<script>
const TILE=48, WORLD_W=20, WORLD_H=15;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

// ==== BGM ====
let audioCtx=null, bgmSource=null, bgmGain=null;
function initBGM(){
  if(audioCtx)return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  fetch("https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/beatbox-loop/techno.wav")
    .then(res=>res.arrayBuffer())
    .then(buf=>audioCtx.decodeAudioData(buf))
    .then(audio=>{
      bgmGain=audioCtx.createGain();
      bgmGain.gain.value=0.5;
      bgmSource=audioCtx.createBufferSource();
      bgmSource.buffer=audio;
      bgmSource.loop=true;
      bgmSource.connect(bgmGain).connect(audioCtx.destination);
      bgmSource.start(0);
    });
}
canvas.addEventListener("touchstart",()=>{initBGM();},{once:true,passive:false});

// === フィールド ===
const world=[ /* 同じマップ */ 
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
 [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,3,3,0,1],
 [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,3,3,0,1],
 [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
 [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
 [1,0,2,0,2,0,0,0,0,0,0,2,0,2,0,0,0,0,0,1],
 [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const player={x:10,y:7,px:10*TILE,py:7*TILE,dir:'down',moving:false,moveDir:null};
const camera={x:0,y:0};

// === NPC ===
const npcs=[
  {x:8,y:7,px:8*TILE,py:7*TILE,textBefore:[
    "こんにちは、旅の人。","この先の森には不思議な光が見えるんだ。","気をつけて進むといいよ。"
  ],textAfter:[
    "おお…『龍のうろこ』を手に入れたのか！","その力があれば、古の封印も解けるかもしれない。"
  ]},
  {x:14,y:5,px:14*TILE,py:5*TILE,textBefore:[
    "おや、見かけない顔だね。","私はこの村の長老だ。","昔、ここに竜が眠っていたという。"
  ],textAfter:[
    "龍のうろこ…それは伝説の証。","君がそれを見つけたのなら、運命が動き出したのかもしれない。"
  ]}
];

const dialog=document.getElementById("dialog");
let activeNPC=null,dialogIndex=0,dialogVisible=false;
let touchStartX=null,touchStartY=null,currentDir=null,isTouching=false;
let npcMoveTimer=0;
let hasDragonScale=false;
const item={x:12,y:9,collected:false};

function isWalkable(x,y){
  if(x<0||y<0||x>=WORLD_W||y>=WORLD_H)return false;
  if(world[y][x]===1||world[y][x]===4)return false;
  for(const npc of npcs){
    if(Math.round(npc.x)===x&&Math.round(npc.y)===y)return false;
  }
  return true;
}

/* === プレイヤー移動 === */
function movePlayer(dir){
  if(player.moving||dialogVisible)return;
  let nx=player.x,ny=player.y;
  if(dir==='up')ny--;if(dir==='down')ny++;if(dir==='left')nx--;if(dir==='right')nx++;
  if(!isWalkable(nx,ny))return;
  player.moving=true;player.dir=dir;
  const sx=player.x*TILE,sy=player.y*TILE,tx=nx*TILE,ty=ny*TILE;
  const start=performance.now(),duration=160;
  function step(){
    const t=Math.min((performance.now()-start)/duration,1);
    player.px=sx+(tx-sx)*t;
    player.py=sy+(ty-sy)*t;
    if(t<1)requestAnimationFrame(step);
    else{player.x=nx;player.y=ny;player.moving=false;}
  }
  requestAnimationFrame(step);
}

/* === カメラ === */
function updateCamera(){
  camera.x+=(player.px+TILE/2-480/2-camera.x)*0.2;
  camera.y+=(player.py+TILE/2-384/2-camera.y)*0.2;
}

/* === NPC移動 === */
function updateNPCs(dt){
  npcMoveTimer+=dt;
  if(npcMoveTimer>=5000){
    npcMoveTimer=0;
    for(const npc of npcs){
      if(activeNPC===npc)continue;
      const dir=Math.floor(Math.random()*4);
      const dx=[1,-1,0,0][dir];
      const dy=[0,0,1,-1][dir];
      const nx=Math.round(npc.x)+dx;
      const ny=Math.round(npc.y)+dy;
      if(isWalkable(nx,ny)){
        npc.x=nx;npc.y=ny;
        npc.px=nx*TILE;npc.py=ny*TILE;
      }
    }
  }
}

/* === NPC距離 === */
function checkNPCProximity(){
  if(dialogVisible)return;
  for(const npc of npcs){
    const dx=Math.abs(npc.x-player.x);
    const dy=Math.abs(npc.y-player.y);
    if(dx<=1&&dy<=1){
      dialogIndex=0;
      const textList=hasDragonScale?npc.textAfter:npc.textBefore;
      showDialog(textList[0]);
      activeNPC=npc;
      return;
    }
  }
  activeNPC=null;
}

/* === ダイアログ === */
function showDialog(text){
  dialog.style.display="block";
  dialog.textContent=text;
  dialogVisible=true;
}
function hideDialog(){
  dialog.style.display="none";
  dialogVisible=false;
}
function nextDialog(){
  if(!activeNPC)return;
  const textList=hasDragonScale?activeNPC.textAfter:activeNPC.textBefore;
  dialogIndex++;
  if(dialogIndex<textList.length)showDialog(textList[dialogIndex]);
  else {hideDialog();activeNPC=null;}
}
dialog.addEventListener("touchstart",e=>{
  e.preventDefault();
  nextDialog();
},{passive:false});

/* === スワイプ === */
canvas.addEventListener("touchstart",e=>{
  e.preventDefault();
  const t=e.touches[0];
  touchStartX=t.clientX;touchStartY=t.clientY;
  isTouching=true;
},{passive:false});
canvas.addEventListener("touchmove",e=>{
  e.preventDefault();
  if(!isTouching)return;
  const t=e.touches[0];
  const dx=t.clientX-touchStartX,dy=t.clientY-touchStartY;
  let dir=null;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>20)dir='right';else if(dx<-20)dir='left';
  }else{
    if(dy>20)dir='down';else if(dy<-20)dir='up';
  }
  if(dir&&dir!==currentDir){currentDir=dir;movePlayer(dir);}
},{passive:false});
canvas.addEventListener("touchend",e=>{
  e.preventDefault();
  isTouching=false;currentDir=null;
},{passive:false});

/* === アイテム === */
canvas.addEventListener("touchstart",e=>{
  const rect=canvas.getBoundingClientRect();
  const tx=Math.floor((e.touches[0].clientX-rect.left+camera.x)/TILE);
  const ty=Math.floor((e.touches[0].clientY-rect.top+camera.y)/TILE);
  if(!item.collected && tx===item.x && ty===item.y){
    item.collected=true;hasDragonScale=true;
    showDialog("『龍のうろこ』を手に入れた！");
  }
},{passive:false});

/* === 描画 === */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<WORLD_H;y++)for(let x=0;x<WORLD_W;x++){
    const t=world[y][x];
    ctx.fillStyle=t===1?'#2b4f2b':t===2?'#c9a36e':t===3?'#7aa8c2':t===4?'#2a9':'#3a8a3a';
    ctx.fillRect(x*TILE-camera.x,y*TILE-camera.y,TILE,TILE);
  }
  if(!item.collected){
    ctx.fillStyle="#0ff";
    ctx.beginPath();
    ctx.arc(item.x*TILE+TILE/2-camera.x,item.y*TILE+TILE/2-camera.y,10,0,Math.PI*2);
    ctx.fill();
  }
  for(const npc of npcs){
    ctx.fillStyle="#ff5";
    ctx.fillRect(npc.px-camera.x+4,npc.py-camera.y+4,TILE-8,TILE-8);
  }
  ctx.fillStyle="#66f";
  ctx.fillRect(player.px-camera.x+6,player.py-camera.y+6,TILE-12,TILE-12);
}

/* === ループ === */
let last=performance.now();
function loop(now){
  const dt=now-last;last=now;
  updateCamera();
  if(!player.moving&&isTouching&&currentDir)movePlayer(currentDir);
  updateNPCs(dt);
  checkNPCProximity();
  render();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
