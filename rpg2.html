<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>蒼の村と宝箱</title>
<style>
body{background:#ddeeff;margin:0;padding:0;font-family:sans-serif;overflow:hidden;}
#game{display:block;margin:20px auto;border:4px solid #444;image-rendering:pixelated;}
.bubble{
  position:absolute;
  background:white;
  border:2px solid #333;
  border-radius:10px;
  padding:6px 10px;
  font-size:14px;
  max-width:140px;
  line-height:1.3;
}
#msg{
  position:absolute;
  bottom:10px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.6);color:#fff;padding:8px 12px;border-radius:10px;
  display:none;font-size:14px;
}
</style>
</head>
<body>
<canvas id="game" width="240" height="240"></canvas>
<div id="bubble" class="bubble" style="display:none;"></div>
<div id="msg">宝箱を開けた！中には金色のコインが入っていた！</div>
<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const bubble=document.getElementById("bubble");
const msgBox=document.getElementById("msg");

const tile=48;
let keys={};
let player={x:2,y:2,size:40,speed:2,vx:0,vy:0};
let hasTreasure=false;
let treasure={x:3,y:4,opened:false};
let npcs=[
  {
    x:4,y:3,color:"orange",
    msgNormal:[
      "やあ旅人さん、この村へようこそ！",
      "昔この村のどこかに宝箱が隠されたという話を聞いたことがあるよ。",
      "誰も見つけたことがないけどね……"
    ],
    msgTreasure:[
      "おお！その手に光るのは……まさか伝説のコイン！？",
      "本当に見つけたんだね……村の希望が戻ってきたよ。ありがとう。"
    ],
    moveTimer:0, paused:false
  },
  {
    x:1,y:5,color:"green",
    msgNormal:[
      "畑仕事はたいへんだよ、毎日土と汗の匂いだ。",
      "でも、この村には豊かな実りと優しい人たちがいる。",
      "だからこそ頑張れるんだ。"
    ],
    msgTreasure:[
      "おや、それが噂の宝かい？",
      "村長が喜ぶだろうねぇ。よく見つけたもんだ。"
    ],
    moveTimer:0, paused:false
  }
];

let activeNpc=null;
let msgIndex=0;
let cancelLock=false; // 会話キャンセル後に再接近まで再会話禁止
let lastTime=performance.now();

// --- キー操作 ---
window.addEventListener("keydown",e=>{keys[e.key]=true;});
window.addEventListener("keyup",e=>{keys[e.key]=false;});

// --- 会話操作 ---
bubble.addEventListener("click",()=>{
  if(!activeNpc)return;
  msgIndex++;
  const msgs = hasTreasure ? activeNpc.msgTreasure : activeNpc.msgNormal;
  if(msgIndex>=msgs.length){
    bubble.style.display="none";
    activeNpc.paused=false;
    activeNpc=null;
    cancelLock=true;
  }else{
    bubble.textContent=msgs[msgIndex];
  }
});

// 長押しキャンセル
let touchTimer;
bubble.addEventListener("touchstart",()=>{
  touchTimer=setTimeout(()=>{
    if(activeNpc){
      bubble.style.display="none";
      activeNpc.paused=false;
      activeNpc=null;
      cancelLock=true;
    }
  },700);
});
bubble.addEventListener("touchend",()=>clearTimeout(touchTimer));

// --- 宝箱タップ ---
canvas.addEventListener("click",(e)=>{
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left)/tile;
  const y=(e.clientY-rect.top)/tile;
  if(Math.abs(player.x-treasure.x)<1 && Math.abs(player.y-treasure.y)<1 && !treasure.opened){
    treasure.opened=true;
    hasTreasure=true;
    msgBox.style.display="block";
    setTimeout(()=>msgBox.style.display="none",2500);
  }
});

// --- NPC動作 ---
function updateNPCs(dt){
  npcs.forEach(n=>{
    if(n.paused)return;
    n.moveTimer+=dt;
    if(n.moveTimer>5000){
      n.moveTimer=0;
      const dir=Math.floor(Math.random()*4);
      const dx=[1,-1,0,0][dir];
      const dy=[0,0,1,-1][dir];
      const newX=n.x+dx, newY=n.y+dy;
      if(newX>=0&&newX<5&&newY>=0&&newY<5) n.x=newX,n.y=newY;
    }
  });
}

// --- 当たり判定 ---
function collide(ax,ay,bx,by){
  return Math.abs(ax-bx)<0.8 && Math.abs(ay-by)<0.8;
}

// --- プレイヤー ---
function updatePlayer(){
  let speed=0.08;
  player.vx=player.vy=0;
  if(keys["ArrowUp"])player.vy=-speed;
  if(keys["ArrowDown"])player.vy=speed;
  if(keys["ArrowLeft"])player.vx=-speed;
  if(keys["ArrowRight"])player.vx=speed;

  let newX=player.x+player.vx;
  let newY=player.y+player.vy;

  for(const n of npcs){
    if(collide(newX,newY,n.x,n.y))return;
  }
  player.x=newX;
  player.y=newY;
}

// --- 会話判定 ---
function checkTalk(){
  if(activeNpc||cancelLock)return;
  for(const n of npcs){
    if(Math.abs(player.x-n.x)<1 && Math.abs(player.y-n.y)<1){
      activeNpc=n;
      n.paused=true;
      msgIndex=0;
      const msgs = hasTreasure ? n.msgTreasure : n.msgNormal;
      bubble.textContent=msgs[0];
      bubble.style.display="block";
      const bx=n.x*tile+tile/2-bubble.offsetWidth/2+canvas.offsetLeft;
      const by=n.y*tile-20+canvas.offsetTop;
      bubble.style.left=bx+"px";
      bubble.style.top=by+"px";
      return;
    }
  }
  // プレイヤーがどのNPCからも離れたらキャンセルロック解除
  cancelLock=false;
}

// --- 描画 ---
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#88cc88";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // 宝箱
  ctx.fillStyle=treasure.opened?"#aa8844":"#ccaa00";
  ctx.fillRect(treasure.x*tile+10,treasure.y*tile+10,tile-20,tile-20);

  // NPC
  npcs.forEach(n=>{
    ctx.fillStyle=n.color;
    ctx.fillRect(n.x*tile+4,n.y*tile+4,tile-8,tile-8);
  });

  // プレイヤー
  ctx.fillStyle="blue";
  ctx.beginPath();
  ctx.arc(player.x*tile+tile/2,player.y*tile+tile/2,player.size/2/1.5,0,Math.PI*2);
  ctx.fill();
}

// --- メインループ ---
function loop(now){
  const dt=now-lastTime;lastTime=now;
  updatePlayer();
  updateNPCs(dt);
  checkTalk();
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
