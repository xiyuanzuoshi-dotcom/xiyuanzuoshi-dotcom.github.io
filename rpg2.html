<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>スマホドットRPG — スワイプ操作版（改良）</title>
<style>
  html,body{height:100%;margin:0;background:#071018;color:#e6f7ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;touch-action:none;}
  #wrap{display:flex;flex-direction:column;align-items:center;gap:8px;padding:10px}
  canvas{image-rendering:pixelated;border:6px solid #111;background:#073;display:block;touch-action:none;}
  .controls{position:relative;width:100%;max-width:520px;height:100px;margin-top:8px;}
  .actions{position:absolute;right:8px;bottom:6px;display:flex;flex-direction:column;gap:12px;}
  .btn{width:72px;height:72px;border-radius:14px;background:#c33;border:3px solid #700;color:#fff;font-weight:900;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 6px 0 rgba(0,0,0,0.6);}
  .btn.b{background:#444;border:3px solid #222;}
  #dialog{position:fixed;left:50%;transform:translateX(-50%);bottom:170px;max-width:94%;background:rgba(0,0,0,0.9);color:#fff;border:3px solid #333;padding:10px;border-radius:10px;font-size:16px;display:none;}
  .help{font-size:13px;color:#9fd;text-align:center;}
  @media(min-width:760px){canvas{width:760px;height:auto;}}
</style>
</head>
<body>
<div id="wrap">
  <h3>スマホドットRPG — スワイプ操作版（改良）</h3>
  <canvas id="game" width="480" height="384"></canvas>
  <div class="help">スワイプで移動 / 指を離すまで動き続ける / A: 話す / B: キャンセル</div>
  <div class="controls">
    <div class="actions">
      <div class="btn a" id="btnA">A</div>
      <div class="btn b" id="btnB">B</div>
    </div>
  </div>
</div>

<div id="dialog"><p id="dialog-text"></p></div>

<script>
/* === ゲーム設定 === */
const TILE=48;
const WORLD_W=20, WORLD_H=15;
const VIEW_W=10, VIEW_H=8;
const VIEW_PX_W=VIEW_W*TILE, VIEW_PX_H=VIEW_H*TILE;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

const world=[ /* 同じマップ省略 */ 
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
 [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,3,3,0,1],
 [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,3,3,0,1],
 [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
 [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
 [1,0,2,0,2,0,0,0,0,0,0,2,0,2,0,0,0,0,0,1],
 [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];
const entrance={x:19,y:7};
const player={x:10,y:7,dir:"down",moving:false,px:10*TILE,py:7*TILE,speed:180};
const camera={x:0,y:0,targetX:0,targetY:0};

/* === 会話UI === */
const dialogEl=document.getElementById('dialog');
const dialogText=document.getElementById('dialog-text');
let dialogQueue=[];
function showDialog(lines){dialogQueue=lines.slice();dialogEl.style.display='block';dialogText.textContent=dialogQueue.shift()||'';}
function nextDialog(){if(dialogQueue.length>0)dialogText.textContent=dialogQueue.shift();else dialogEl.style.display='none';}
function isWalkable(x,y){if(x<0||y<0||x>=WORLD_W||y>=WORLD_H)return false;const t=world[y][x];return t!==1&&t!==4;}

/* === スムーズ移動 === */
function attemptMove(dir){
  if(player.moving||dialogEl.style.display==='block')return false;
  let nx=player.x,ny=player.y;
  if(dir==='up')ny--;if(dir==='down')ny++;if(dir==='left')nx--;if(dir==='right')nx++;
  if(nx===entrance.x&&ny===entrance.y){window.location.href='forest.html';return;}
  if(!isWalkable(nx,ny))return false;

  player.moving=true;
  player.dir=dir;
  const startX=player.x*TILE, startY=player.y*TILE;
  const targetX=nx*TILE, targetY=ny*TILE;
  const startTime=performance.now();
  const duration=player.speed;

  function step(){
    const t=Math.min(1,(performance.now()-startTime)/duration);
    // ease-in-out 補間
    const ease=t<0.5?2*t*t:-1+(4-2*t)*t;
    player.px=startX+(targetX-startX)*ease;
    player.py=startY+(targetY-startY)*ease;
    if(t<1){requestAnimationFrame(step);}
    else{
      player.x=nx;player.y=ny;
      player.px=targetX;player.py=targetY;
      player.moving=false;
    }
  }
  requestAnimationFrame(step);
  return true;
}

/* === A/Bボタン === */
function pressA(){if(dialogEl.style.display==='block'){nextDialog();return;}showDialog(['誰もいない…']);}
function pressB(){dialogEl.style.display='none';dialogQueue=[];}

/* === カメラと描画 === */
function updateCameraTarget(){
  let tx=player.px+TILE/2-VIEW_PX_W/2;
  let ty=player.py+TILE/2-VIEW_PX_H/2;
  tx=Math.max(0,Math.min(tx,WORLD_W*TILE-VIEW_PX_W));
  ty=Math.max(0,Math.min(ty,WORLD_H*TILE-VIEW_PX_H));
  camera.targetX=tx;camera.targetY=ty;
}
function render(){
  camera.x+=(camera.targetX-camera.x)*0.2;
  camera.y+=(camera.targetY-camera.y)*0.2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<WORLD_H;y++)for(let x=0;x<WORLD_W;x++){
    const t=world[y][x];
    ctx.fillStyle=t===1?'#2b4f2b':t===2?'#c9a36e':t===3?'#7aa8c2':t===4?'#2a9':'#3a8a3a';
    ctx.fillRect(x*TILE-camera.x,y*TILE-camera.y,TILE,TILE);
  }
  ctx.fillStyle='#66f';
  ctx.fillRect(player.px-camera.x+4,player.py-camera.y+4,TILE-8,TILE-8);
}

/* === ゲームループ === */
let moveDir=null, touchActive=false;
function gameLoop(){
  updateCameraTarget();
  render();

  // 押しっぱなし移動継続
  if(touchActive && !player.moving && moveDir){
    attemptMove(moveDir);
  }
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

/* === スワイプ操作（押しっぱなし対応） === */
let startX=null, startY=null;
canvas.addEventListener('touchstart',e=>{
  const t=e.touches[0];
  startX=t.clientX; startY=t.clientY;
  touchActive=true;
});
canvas.addEventListener('touchmove',e=>{
  if(!startX||!startY)return;
  const t=e.touches[0];
  const dx=t.clientX-startX, dy=t.clientY-startY;
  const absX=Math.abs(dx), absY=Math.abs(dy);
  const dir = absX>absY ? (dx>0?'right':'left') : (dy>0?'down':'up');
  if(dir!==moveDir){
    moveDir=dir; // 方向転換で即再移動
  }
});
canvas.addEventListener('touchend',()=>{
  startX=startY=null;
  touchActive=false;
  moveDir=null;
});

/* === A/Bボタン === */
document.getElementById('btnA').addEventListener('touchstart',()=>pressA());
document.getElementById('btnB').addEventListener('touchstart',()=>pressB());
</script>
</body>
</html>
