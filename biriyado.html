<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>完全ビリヤード改良版</title>
<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#0b3d91;}
canvas{display:block;margin:0 auto;background:#006400;}
#info{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  color:white;font-size:18px;text-align:center;
}
</style>
</head>
<body>
<div id="info">ドラッグで白球を打とう！</div>
<canvas id="game" width="800" height="500"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// ボール定義
let balls = [
  {x:100,y:250,r:10,vx:0,vy:0,moving:false,isCue:true},
  {x:500,y:200,r:10,vx:0,vy:0,moving:false,score:true},
  {x:550,y:250,r:10,vx:0,vy:0,moving:false,score:true},
  {x:500,y:300,r:10,vx:0,vy:0,moving:false,score:true}
];

// ポケット定義（大きくした）
const pockets = [
  {x:0,y:0,r:30}, {x:canvas.width/2,y:0,r:30}, {x:canvas.width,y:0,r:30},
  {x:0,y:canvas.height,r:30}, {x:canvas.width/2,y:canvas.height,r:30}, {x:canvas.width,y:canvas.height,r:30}
];

let dragging = false;
let dragStart = null;
let particles = [];
let shots = 0;

// マウス操作
canvas.addEventListener('mousedown', e=>{
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    const cue = balls.find(b=>b.isCue);
    const dx = mx-cue.x;
    const dy = my-cue.y;
    if(Math.sqrt(dx*dx+dy*dy)<cue.r*2 && !anyBallMoving()){
        dragging = true;
        dragStart = {x:mx,y:my};
    }
});

canvas.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const rect = canvas.getBoundingClientRect();
    dragStart.x = e.clientX - rect.left;
    dragStart.y = e.clientY - rect.top;
});

canvas.addEventListener('mouseup', e=>{
    if(!dragging) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    const cue = balls.find(b=>b.isCue);
    const dx = cue.x - mx;
    const dy = cue.y - my;
    cue.vx = dx*0.2;
    cue.vy = dy*0.2;
    cue.moving = true;
    shots++;
    dragging = false;
});

// 移動中チェック
function anyBallMoving(){
    return balls.some(b=>b.moving);
}

// パーティクル
function createParticles(x,y){
    for(let i=0;i<30;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = Math.random()*4;
        particles.push({x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:50});
    }
}

// 物理更新
function updatePhysics(){
    // 衝突
    for(let i=0;i<balls.length;i++){
        for(let j=i+1;j<balls.length;j++){
            const b1=balls[i], b2=balls[j];
            const dx = b2.x-b1.x;
            const dy = b2.y-b1.y;
            const dist = Math.sqrt(dx*dx+dy*dy);
            if(dist < b1.r + b2.r){
                const nx = dx/dist;
                const ny = dy/dist;
                // 衝突強度によって反射速度を増減
                const relativeVelocity = Math.sqrt((b1.vx-b2.vx)**2+(b1.vy-b2.vy)**2);
                const p = 2*(b1.vx*nx + b1.vy*ny - b2.vx*nx - b2.vy*ny)/2 * Math.min(1.5, relativeVelocity/5);
                b1.vx -= p*nx; b1.vy -= p*ny;
                b2.vx += p*nx; b2.vy += p*ny;

                const overlap = b1.r+b2.r - dist;
                b1.x -= nx*overlap/2; b1.y -= ny*overlap/2;
                b2.x += nx*overlap/2; b2.y += ny*overlap/2;

                // 衝突後は確実に移動する
                b1.moving = true; b2.moving = true;
            }
        }
    }

    // ボール移動
    for(const b of balls){
        if(b.moving){
            b.x += b.vx; b.y += b.vy;

            // 壁反射
            if(b.x-b.r<0){b.x=b.r;b.vx*=-1;}
            if(b.x+b.r>canvas.width){b.x=canvas.width-b.r;b.vx*=-1;}
            if(b.y-b.r<0){b.y=b.r;b.vy*=-1;}
            if(b.y+b.r>canvas.height){b.y=canvas.height-b.r;b.vy*=-1;}

            // 摩擦
            b.vx *= 0.98; b.vy *= 0.98;
            if(Math.abs(b.vx)<0.1 && Math.abs(b.vy)<0.1) b.moving=false;

            // ポケット判定
            for(const p of pockets){
                const dx = b.x-p.x; const dy=b.y-p.y;
                if(Math.sqrt(dx*dx+dy*dy)<p.r){
                    if(b.score) shotsScore++;
                    b.moving=false;
                    createParticles(b.x,b.y);
                    b.x=-1000;b.y=-1000;
                }
            }
        }
    }
}

// 描画
let shotsScore=0;
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // ポケット描画
    ctx.fillStyle='black';
    for(const p of pockets){
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
    }

    // ボール描画
    for(const b of balls){
        ctx.fillStyle = b.isCue?'white':'red';
        ctx.beginPath();
        ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
        ctx.fill();
    }

    // ドラッグ矢印
    if(dragging){
        const cue = balls.find(b=>b.isCue);
        const dx = cue.x-dragStart.x;
        const dy = cue.y-dragStart.y;
        const angle = Math.atan2(dy,dx);
        const length = Math.min(Math.sqrt(dx*dx+dy*dy),150);
        const endX = cue.x - Math.cos(angle)*length;
        const endY = cue.y - Math.sin(angle)*length;
        ctx.strokeStyle='yellow'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.moveTo(cue.x,cue.y); ctx.lineTo(endX,endY); ctx.stroke();

        // 矢印先端
        ctx.beginPath();
        ctx.moveTo(endX,endY);
        ctx.lineTo(endX - 10*Math.cos(angle-Math.PI/6), endY - 10*Math.sin(angle-Math.PI/6));
        ctx.lineTo(endX - 10*Math.cos(angle+Math.PI/6), endY - 10*Math.sin(angle+Math.PI/6));
        ctx.lineTo(endX,endY);
        ctx.fillStyle='yellow'; ctx.fill();
    }

    // パーティクル
    for(let i=particles.length-1;i>=0;i--){
        const p=particles[i];
        p.x+=p.vx; p.y+=p.vy; p.life-=1;
        ctx.fillStyle=`rgba(255,255,0,${p.life/50})`;
        ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
        if(p.life<=0) particles.splice(i,1);
    }

    // スコア表示
    ctx.fillStyle='white'; ctx.font='20px sans-serif';
    ctx.fillText(`ショット数: ${shots}`,10,30);
}

// ゲームループ
function loop(){
    updatePhysics();
    draw();
    requestAnimationFrame(loop);

    // ゲームクリア判定
    if(balls.filter(b=>b.score).length===0 && !dragging){
        ctx.fillStyle='white';
        ctx.font='40px sans-serif';
        ctx.fillText(`ゲームクリア! ショット数: ${shots}`,150,250);
    }
}

loop();
</script>
</body>
</html>
