<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ふわもこぷにん惑星ゲーム</title>
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#001;font-family:sans-serif;}
#game{display:block;margin:0 auto;background:#001;}
#hud{position:fixed;left:12px;top:12px;font-size:18px;color:white;}
#overlay{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);color:white;font-size:32px;flex-direction:column;visibility:hidden;}
button{padding:10px 20px;font-size:18px;border:none;border-radius:8px;background:#06f;color:white;cursor:pointer;}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hud">スコア:0</div>
<div id="overlay"><div id="resultText"></div><button onclick="restart()">リトライ</button></div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
let score=0,gameOver=false;

function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
window.addEventListener("resize",resize);
resize();

const keys={};
window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

const center={x:canvas.width/2,y:canvas.height/2};
const player={x:center.x,y:center.y,r:20,color:"pink",vx:0,vy:0,scale:1,scaleDecay:0.05};

let obstacles=[];
let bubbles=[];

function randRange(a,b){return a+Math.random()*(b-a);}
function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}

function spawnObstacle(){
  const r=randRange(20,50);
  obstacles.push({x:randRange(r,canvas.width-r),y:randRange(r,canvas.height-r),r:r,color:`hsla(${randRange(0,360)},70%,85%,0.6)`});
}
for(let i=0;i<6;i++) spawnObstacle();

function applyPunin(o,ob){
  const dx=o.x-ob.x, dy=o.y-ob.y, d=Math.hypot(dx,dy);
  const nx=dx/d||0, ny=dy/d||0;
  o.vx+=nx*0.1*ob.r;
  o.vy+=ny*0.1*ob.r;
  o.scale=1.4; // ぷにん膨らむ
  // ふわもこパーティクル
  for(let i=0;i<5;i++){
    bubbles.push({
      x:o.x+randRange(-5,5),
      y:o.y+randRange(-5,5),
      r:randRange(3,6),
      vy:randRange(-1.5,-0.5),
      color:`hsla(${randRange(200,300)},60%,85%,0.4)`
    });
  }
}

let safeTimer=60;

function movePlayer(){
  const s=0.2;
  if(keys["ArrowUp"]||keys["w"]) player.vy-=s;
  if(keys["ArrowDown"]||keys["s"]) player.vy+=s;
  if(keys["ArrowLeft"]||keys["a"]) player.vx-=s;
  if(keys["ArrowRight"]||keys["d"]) player.vx+=s;
  player.x+=player.vx; player.y+=player.vy;
  player.vx*=0.95; player.vy*=0.95;
  if(player.x<player.r)player.x=player.r;
  if(player.x>canvas.width-player.r)player.x=canvas.width-player.r;
  if(player.y<player.r)player.y=player.r;
  if(player.y>canvas.height-player.r)player.y=canvas.height-player.r;
  if(player.scale>1){player.scale-=player.scaleDecay;if(player.scale<1)player.scale=1;}
}

function checkCollisions(){
  let touching=false;
  for(let i=0;i<obstacles.length;i++){
    const o=obstacles[i];
    const d=dist(player,o);
    if(d<player.r+o.r){
      touching=true;
      applyPunin(player,o);
      score++;
      document.getElementById("hud").textContent=`スコア:${score}`;
    } else if(d>player.r+o.r+50 && touching===false){
      // 離れた障害物はふわもこ消滅
      obstacles.splice(i,1);
      spawnObstacle();
    }
  }

  if(safeTimer>0){safeTimer--; return;}

  if(!touching && Math.abs(player.vx)<0.05 && Math.abs(player.vy)<0.05){
    gameOver=true;
    document.getElementById("overlay").style.visibility="visible";
    document.getElementById("resultText").textContent="ゲームオーバー！";
  }
}

function drawPlayer(){
  ctx.save();
  ctx.translate(player.x,player.y);
  ctx.scale(player.scale,1/player.scale);
  ctx.beginPath();
  ctx.arc(0,0,player.r,0,Math.PI*2);
  ctx.fillStyle=player.color;
  ctx.shadowBlur=10; ctx.shadowColor="rgba(255,255,255,0.3)";
  ctx.fill();
  ctx.restore();
}

function drawObstacles(){
  for(const o of obstacles){
    ctx.beginPath();
    ctx.arc(o.x,o.y,o.r,0,Math.PI*2);
    ctx.fillStyle=o.color;
    ctx.fill();
  }
}

function drawBubbles(){
  for(const b of bubbles){
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
    ctx.fillStyle=b.color;
    ctx.fill();
    b.y+=b.vy;
  }
  if(bubbles.length>150) bubbles.splice(0,bubbles.length-150);
}

function update(){
  if(!gameOver){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    movePlayer();
    checkCollisions();
    drawObstacles();
    drawPlayer();
    drawBubbles();
    requestAnimationFrame(update);
  }
}

function restart(){
  gameOver=false;
  safeTimer=60;
  document.getElementById("overlay").style.visibility="hidden";
  player.x=center.x; player.y=center.y; player.vx=0; player.vy=0; player.scale=1;
  obstacles.length=0;
  for(let i=0;i<6;i++) spawnObstacle();
  score=0;
  document.getElementById("hud").textContent=`スコア:${score}`;
  update();
}

update();
</script>
</body>
</html>
