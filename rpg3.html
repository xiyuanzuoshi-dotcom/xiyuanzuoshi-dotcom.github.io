<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>スマホドットRPG — 竜の目覚めと旅立ち</title>
<style>
html,body{
  height:100%;margin:0;
  background:#071018;color:#e6f7ff;
  font-family:sans-serif;
  touch-action:none;
  overscroll-behavior:none;
}
canvas{
  image-rendering:pixelated;
  border:6px solid #111;
  background:#073;
  display:block;
  margin:20px auto;
  touch-action:none;
}
#dialog{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:140px;
  max-width:94%;
  background:rgba(0,0,0,0.9);
  color:#fff;
  border:3px solid #333;
  padding:12px 14px;
  border-radius:10px;
  font-size:16px;
  display:none;
  transition:opacity 0.3s;
}
#fade{
  position:fixed;
  left:0;top:0;width:100%;height:100%;
  background:#000;opacity:0;
  pointer-events:none;
  transition:opacity 1s;
}
</style>
</head>
<body>
<canvas id="game" width="480" height="384"></canvas>
<div id="dialog"></div>
<div id="fade"></div>

<script>
const TILE=48, WORLD_W=20, WORLD_H=15;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const fade=document.getElementById("fade");

let currentMap="village";

// === マップ定義 ===
const maps={
  village:{
    world:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,3,3,0,1],
      [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,3,3,0,1],
      [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
      [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
      [1,0,2,0,2,0,0,0,0,0,0,2,0,2,0,0,0,0,0,1],
      [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ]
  },

  // ☁ 空のマップ定義
  sky:{
    world:[
      [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
      [3,3,0,0,0,3,3,3,3,3,3,3,0,0,0,3,3,3,3,3],
      [3,3,0,1,0,3,3,3,3,3,3,3,0,1,0,3,3,3,3,3],
      [3,3,0,0,0,3,3,3,3,3,3,3,0,0,0,3,3,3,3,3],
      [3,3,3,3,0,0,0,0,0,0,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,0,1,0,1,0,0,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,0,0,0,0,0,0,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
      [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]
    ]
  }
};

// === 状態 ===
const player={x:10,y:7,px:10*TILE,py:7*TILE};
const camera={x:0,y:0};

// === 村のNPC・アイテム・竜 ===
const npcs=[
  {x:8,y:7,px:8*TILE,py:7*TILE,text:["こんにちは、旅の人。","この先の森には不思議な光が見えるんだ。"]},
  {x:14,y:5,px:14*TILE,py:5*TILE,text:[
    "おや、見かけない顔だね。","私はこの村の長老だ。",
    "昔、ここに竜が眠っていたという。","……信じるかい？"
  ]}
];
let item={x:3,y:3,collected:false,name:"光る石"};
let dragon={x:16,y:9,visible:false,size:2,alpha:1,
  text:["……目覚めの光か……。","封印は解かれた。","私は空へ帰る——"]
};

// === 空の世界用データ ===
const skyNPCs=[
  {x:5,y:3,text:[
    "……地上の者よ、よくぞここまで。",
    "私は天空の守護者アウリス。",
    "竜はあなたを信じている。","これを受け取りなさい。"
  ],gaveItem:false}
];
let skyItem={x:8,y:4,collected:false,name:"竜の羽根"};

// === 共通関数 ===
const dialog=document.getElementById("dialog");
function showDialog(t){dialog.textContent=t;dialog.style.display="block";}
function hideDialog(){dialog.style.display="none";}

// === アイテム取得 ===
function checkItemPickup(){
  if(currentMap==="village"&&!item.collected&&player.x===item.x&&player.y===item.y){
    item.collected=true;
    showDialog("『"+item.name+"』を手に入れた！");
    npcs[1].text=["おお…それは伝説の光る石ではないか！","竜が目覚める時だ！"];
    setTimeout(()=>{dragon.visible=true;},2000);
  }
  if(currentMap==="sky"&&!skyItem.collected&&player.x===skyItem.x&&player.y===skyItem.y){
    skyItem.collected=true;
    showDialog("『"+skyItem.name+"』を手に入れた！");
    setTimeout(()=>hideDialog(),2000);
  }
}

// === 竜が飛び立ち空へ ===
function startDragonDeparture(){
  fade.style.opacity=1;
  setTimeout(()=>{
    currentMap="sky";
    fade.style.opacity=0;
    showDialog("——空の世界へ——");
    setTimeout(()=>hideDialog(),3000);
  },1500);
}

// === 描画 ===
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const world=maps[currentMap].world;
  for(let y=0;y<WORLD_H;y++)for(let x=0;x<WORLD_W;x++){
    const t=world[y][x];
    ctx.fillStyle=t===1?'#2b4f2b':t===2?'#c9a36e':t===3?'#6bc3ff':'#3a8a3a';
    ctx.fillRect(x*TILE-camera.x,y*TILE-camera.y,TILE,TILE);
  }

  // 村アイテム
  if(currentMap==="village"&&!item.collected){
    ctx.fillStyle="#0ff";
    ctx.beginPath();
    ctx.arc(item.x*TILE+TILE/2-camera.x,item.y*TILE+TILE/2-camera.y,10,0,Math.PI*2);
    ctx.fill();
  }
  // 空アイテム
  if(currentMap==="sky"&&!skyItem.collected){
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(skyItem.x*TILE+TILE/2-camera.x,skyItem.y*TILE+TILE/2-camera.y,10,0,Math.PI*2);
    ctx.fill();
  }

  // 村NPC・竜
  if(currentMap==="village"){
    for(const npc of npcs){
      ctx.fillStyle="#ff5";
      ctx.fillRect(npc.px-camera.x+4,npc.py-camera.y+4,TILE-8,TILE-8);
    }
    if(dragon.visible){
      ctx.globalAlpha=dragon.alpha;
      ctx.fillStyle="#f33";
      ctx.fillRect(dragon.x*TILE-camera.x,dragon.y*TILE-camera.y,TILE*dragon.size,TILE*dragon.size);
      ctx.globalAlpha=1;
    }
  }

  // 空NPC
  if(currentMap==="sky"){
    for(const npc of skyNPCs){
      ctx.fillStyle="#eef";
      ctx.fillRect(npc.x*TILE-camera.x+6,npc.y*TILE-camera.y+6,TILE-12,TILE-12);
    }
  }

  // プレイヤー
  ctx.fillStyle="#66f";
  ctx.fillRect(player.px-camera.x+6,player.py-camera.y+6,TILE-12,TILE-12);
}
function loop(){render();requestAnimationFrame(loop);}
loop();
</script>
</body>
</html>
