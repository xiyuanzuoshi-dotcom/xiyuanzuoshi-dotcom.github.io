<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ã‚¹ãƒãƒ›ãƒ‰ãƒƒãƒˆRPG â€” ç«œã®ç›®è¦šã‚ã¨æ—…ç«‹ã¡</title>
<style>
  html,body{
    height:100%;margin:0;
    background:#071018;color:#e6f7ff;
    font-family:sans-serif;
    touch-action:none;
    overscroll-behavior:none;
  }
  canvas{
    image-rendering:pixelated;
    border:6px solid #111;
    background:#073;
    display:block;
    margin:20px auto;
    touch-action:none;
  }
  #dialog{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:140px;
    max-width:94%;
    background:rgba(0,0,0,0.9);
    color:#fff;
    border:3px solid #333;
    padding:12px 14px;
    border-radius:10px;
    font-size:16px;
    display:none;
    transition:opacity 0.3s;
  }
  #fade{
    position:fixed;
    left:0;top:0;width:100%;height:100%;
    background:#000;
    opacity:0;
    pointer-events:none;
    transition:opacity 1s;
  }
</style>
</head>
<body>
<canvas id="game" width="480" height="384"></canvas>
<div id="dialog"></div>
<div id="fade"></div>

<script>
const TILE=48, WORLD_W=20, WORLD_H=15;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const fade=document.getElementById("fade");

let currentMap="village";

// === ãƒãƒƒãƒ—å®šç¾© ===
const maps={
  village:{
    world:[
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,3,3,0,1],
      [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,3,3,0,1],
      [1,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1],
      [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
      [1,0,2,0,2,0,0,0,0,0,0,2,0,2,0,0,0,0,0,1],
      [1,0,2,2,2,0,0,0,0,0,0,2,2,2,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ]
  },
  sky:{
    world:Array.from({length:15},()=>Array.from({length:20},()=>3)), // å…¨éƒ¨é’ç©º
  }
};

let world=maps.village.world;

// === ã‚­ãƒ£ãƒ©ã¨çŠ¶æ…‹ ===
const player={x:10,y:7,px:10*TILE,py:7*TILE,dir:'down',moving:false};
const camera={x:0,y:0};

const npcs=[
  {x:8,y:7,px:8*TILE,py:7*TILE,text:[
    "ã“ã‚“ã«ã¡ã¯ã€æ—…ã®äººã€‚",
    "ã“ã®å…ˆã®æ£®ã«ã¯ä¸æ€è­°ãªå…‰ãŒè¦‹ãˆã‚‹ã‚“ã ã€‚",
    "æ°—ã‚’ã¤ã‘ã¦é€²ã‚€ã¨ã„ã„ã‚ˆã€‚",
    "â€¦ãã†ãã†ã€æ£®ã®ä¸­ã§ã¯è¶³å…ƒã«ã‚‚æ³¨æ„ã™ã‚‹ã‚“ã ã€‚"
  ]},
  {x:14,y:5,px:14*TILE,py:5*TILE,text:[
    "ãŠã‚„ã€è¦‹ã‹ã‘ãªã„é¡”ã ã­ã€‚",
    "ç§ã¯ã“ã®æ‘ã®é•·è€ã ã€‚",
    "æ˜”ã€ã“ã“ã«ç«œãŒçœ ã£ã¦ã„ãŸã¨ã„ã†ã€‚",
    "â€¦â€¦ä¿¡ã˜ã‚‹ã‹ã„ï¼Ÿ",
    "ã“ã®æ‘ã«ã¯ã¾ã ç§˜å¯†ãŒçœ ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚"
  ]}
];

let item={x:3,y:3,collected:false,name:"å…‰ã‚‹çŸ³"};

let dragon={
  x:16,y:9,visible:false,size:2,alpha:1,
  text:[
    "â€¦â€¦ç›®è¦šã‚ã®å…‰ã‹â€¦â€¦ã€‚",
    "é•·ãçœ ã‚Šã‹ã‚‰ã€ã‚ˆã†ã‚„ãè§£ã‹ã‚ŒãŸã‚ˆã†ã ã€‚",
    "äººã®å­ã‚ˆã€ãã®çŸ³ã‚’ã©ã“ã§æ‰‹ã«å…¥ã‚ŒãŸï¼Ÿ",
    "å°å°ã¯è§£ã‹ã‚ŒãŸã€‚é‹å‘½ã®æ­¯è»ŠãŒå†ã³å›ã‚Šå§‹ã‚ã‚‹â€¦â€¦ã€‚",
    "ä¸–ç•Œã®è¡Œãæœ«ã¯ã€ãŠå‰ã®é¸æŠã«å§”ã­ã‚‰ã‚Œã‚ˆã†â€¦â€¦",
    "ã•ã‚‰ã°ã ã€äººã®å­ã‚ˆã€‚ç§ã¯ç©ºã¸å¸°ã‚‹â€•â€•"
  ]
};

const dialog=document.getElementById("dialog");
let activeNPC=null,dialogIndex=0,dialogVisible=false;
let touchStartX=null,touchStartY=null,currentDir=null,isTouching=false;

function isWalkable(x,y){
  if(x<0||y<0||x>=WORLD_W||y>=WORLD_H)return false;
  if(world[y][x]===1||world[y][x]===4)return false;
  for(const npc of npcs){
    if(Math.round(npc.x)===x&&Math.round(npc.y)===y)return false;
  }
  if(dragon.visible && currentMap==="village"){
    if(x>=dragon.x && x<dragon.x+dragon.size &&
       y>=dragon.y && y<dragon.y+dragon.size){
      return false;
    }
  }
  return true;
}

/* === ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹• === */
function movePlayer(dir){
  if(player.moving)return;
  let nx=player.x,ny=player.y;
  if(dir==='up')ny--;if(dir==='down')ny++;if(dir==='left')nx--;if(dir==='right')nx++;
  if(!isWalkable(nx,ny))return;
  player.moving=true;player.dir=dir;
  const sx=player.x*TILE,sy=player.y*TILE,tx=nx*TILE,ty=ny*TILE;
  const start=performance.now(),duration=160;
  function step(){
    const t=Math.min((performance.now()-start)/duration,1);
    player.px=sx+(tx-sx)*t;
    player.py=sy+(ty-sy)*t;
    if(t<1)requestAnimationFrame(step);
    else{
      player.x=nx;player.y=ny;player.moving=false;
      checkItemPickup();
    }
  }
  requestAnimationFrame(step);
}

/* === ã‚¢ã‚¤ãƒ†ãƒ å–å¾— === */
function checkItemPickup(){
  if(!item.collected && player.x===item.x && player.y===item.y){
    item.collected=true;
    showDialog(`ã€Œ${item.name}ã€ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`);
    npcs[1].text=[
      "ãŠãŠâ€¦ãã‚Œã¯ã¾ã•ã‹ã€ä¼èª¬ã®å…‰ã‚‹çŸ³ã§ã¯ãªã„ã‹ï¼",
      "ã‚ˆããè¦‹ã¤ã‘ã¦ãã‚ŒãŸã€æ—…ã®è€…ã‚ˆã€‚",
      "ãã®å…‰ãŒå°å°ã‚’è§£ãâ€¦â€¦ç«œãŒç›®è¦šã‚ã‚‹æ™‚ã ï¼"
    ];
    setTimeout(()=>{
      dragon.visible=true;
      showDialog("åœ°é¢ãŒéœ‡ãˆã¦ã„ã‚‹â€¦ï¼ç«œãŒç›®ã‚’è¦šã¾ã—ãŸï¼");
      setTimeout(hideDialog,2500);
    },2500);
  }
}

/* === ã‚«ãƒ¡ãƒ©è¿½å¾“ === */
function updateCamera(){
  camera.x+=(player.px+TILE/2-480/2-camera.x)*0.2;
  camera.y+=(player.py+TILE/2-384/2-camera.y)*0.2;
}

/* === è¿‘æ¥ãƒã‚§ãƒƒã‚¯ === */
function checkProximity(){
  let near=null;
  for(const npc of npcs){
    const dx=Math.abs(npc.x-player.x);
    const dy=Math.abs(npc.y-player.y);
    if(dx<=1&&dy<=1){near=npc;break;}
  }
  if(!near && dragon.visible){
    const dx=Math.abs(dragon.x-player.x);
    const dy=Math.abs(dragon.y-player.y);
    if(dx<=2&&dy<=2){near=dragon;}
  }
  if(near!==activeNPC){
    if(near){dialogIndex=0;showDialog(near.text[0]);}
    else hideDialog();
    activeNPC=near;
  }
}

/* === ä¼šè©±é€²è¡Œ === */
function showDialog(text){
  dialog.style.display="block";
  dialog.textContent=text;
  dialogVisible=true;
}
function hideDialog(){
  dialog.style.display="none";
  dialogVisible=false;
}
function nextDialog(){
  if(!activeNPC)return;
  dialogIndex++;
  if(dialogIndex<activeNPC.text.length){
    showDialog(activeNPC.text[dialogIndex]);
  }else{
    if(activeNPC===dragon){
      startDragonDeparture(); // ğŸ‰ç«œãŒé£›ã³ç«‹ã¤
    }
    hideDialog();activeNPC=null;
  }
}

/* === ç«œã®é£›ã³ç«‹ã¡ â†’ æ¬¡ãƒãƒƒãƒ— === */
function startDragonDeparture(){
  let fadeStep=0;
  const flyInterval=setInterval(()=>{
    dragon.y-=0.1; dragon.alpha-=0.02;
    if(dragon.alpha<=0){
      clearInterval(flyInterval);
      fade.style.opacity=1;
      setTimeout(()=>{
        loadNextMap();
      },1500);
    }
  },100);
}

function loadNextMap(){
  currentMap="sky";
  world=maps.sky.world;
  dragon.visible=false;
  fade.style.opacity=0;
  player.x=10;player.y=7;player.px=player.x*TILE;player.py=player.y*TILE;
  showDialog("â€”â€”ç©ºã®ä¸–ç•Œã¸â€”â€”");
  setTimeout(hideDialog,3000);
}

/* === ã‚¿ãƒƒãƒæ“ä½œ === */
let holdTimer=null,isHolding=false;
dialog.addEventListener("touchstart",()=>{
  isHolding=false;
  holdTimer=setTimeout(()=>{isHolding=true;hideDialog();activeNPC=null;},600);
});
dialog.addEventListener("touchend",()=>{
  if(holdTimer)clearTimeout(holdTimer);
  if(!isHolding)nextDialog();
});

canvas.addEventListener("touchstart",e=>{
  e.preventDefault();
  const t=e.touches[0];
  touchStartX=t.clientX;touchStartY=t.clientY;isTouching=true;
});
canvas.addEventListener("touchmove",e=>{
  e.preventDefault();
  if(!isTouching)return;
  const t=e.touches[0];
  const dx=t.clientX-touchStartX,dy=t.clientY-touchStartY;
  let dir=null;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>20)dir='right';else if(dx<-20)dir='left';
  }else{
    if(dy>20)dir='down';else if(dy<-20)dir='up';
  }
  if(dir&&dir!==currentDir){currentDir=dir;movePlayer(dir);}
});
canvas.addEventListener("touchend",e=>{
  e.preventDefault();
  isTouching=false;currentDir=null;
});

/* === æç”» === */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let y=0;y<WORLD_H;y++)for(let x=0;x<WORLD_W;x++){
    const t=world[y][x];
    ctx.fillStyle=t===1?'#2b4f2b':t===2?'#c9a36e':t===3?'#6bc3ff':t===4?'#2a9':'#3a8a3a';
    ctx.fillRect(x*TILE-camera.x,y*TILE-camera.y,TILE,TILE);
  }
  if(!item.collected && currentMap==="village"){
    ctx.fillStyle="#0ff";
    ctx.beginPath();
    ctx.arc(item.x*TILE+TILE/2-camera.x,item.y*TILE+TILE/2-camera.y,10,0,Math.PI*2);
    ctx.fill();
  }
  if(dragon.visible && currentMap==="village"){
    ctx.globalAlpha=dragon.alpha;
    ctx.fillStyle="#f33";
    ctx.fillRect(dragon.x*TILE-camera.x,dragon.y*TILE-camera.y,TILE*dragon.size,TILE*dragon.size);
    ctx.globalAlpha=1;
  }
  for(const npc of npcs){
    ctx.fillStyle="#ff5";
    ctx.fillRect(npc.px-camera.x+4,npc.py-camera.y+4,TILE-8,TILE-8);
  }
  ctx.fillStyle="#66f";
  ctx.fillRect(player.px-camera.x+6,player.py-camera.y+6,TILE-12,TILE-12);
}

/* === ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— === */
let last=performance.now();
function loop(now){
  const dt=now-last;last=now;
  updateCamera();
  if(!player.moving&&isTouching&&currentDir)movePlayer(currentDir);
  checkProximity();
  render();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
