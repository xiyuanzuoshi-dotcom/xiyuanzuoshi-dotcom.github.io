<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ユイとの最後のひととき</title>
<style>
body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 0;
  background-color: #000;
  overflow: hidden;
}
#game-container { position: relative; width: 100%; height: 100vh; overflow: hidden; }
#background {
  position: absolute; inset: 0;
  background-size: cover;
  background-position: center;
  transition: background-image 0.5s ease-in-out;
  z-index: 0;
}
#character {
  position: absolute;
  bottom: 0; left: 50%;
  transform: translateX(-50%);
  width: 350px; height: 550px;
  background-size: contain;
  background-position: bottom center;
  background-repeat: no-repeat;
  z-index: 1;
}
#game-text {
  position: absolute;
  bottom: 220px; left: 50%;
  transform: translateX(-50%);
  color: white; font-size: 1.6em;
  width: 80%; text-align: center; line-height: 1.5em;
  padding: 15px 20px;
  background-color: rgba(0, 0, 0, 0.6);
  border-radius: 12px; z-index: 2;
}
#choices {
  position: absolute;
  bottom: 30px; left: 50%;
  transform: translateX(-50%);
  width: 80%; text-align: center;
  display: flex; flex-direction: column;
  gap: 15px; z-index: 2;
}
#action-buttons {
  position: absolute;
  top: 20px; right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 5;
}
button {
  font-size: 1.1em;
  padding: 15px 20px;
  border-radius: 10px;
  border: 2px solid #ccc;
  background-color: rgba(255, 255, 255, 0.8);
  color: #333;
  cursor: pointer;
  transition: all 0.3s ease;
}
button:hover { background-color: rgba(255, 255, 255, 1); }

#world-shift-effect {
  position: fixed; inset: 0; background: black; z-index: 10000;
  overflow: hidden; animation: pixelShift 1.5s ease forwards;
}
#world-shift-effect .scanline {
  position: absolute; inset: 0;
  background-image: repeating-linear-gradient(to bottom, rgba(255,255,255,0.05) 0px, rgba(0,0,0,0.1) 2px, transparent 4px);
  animation: scan 1s linear infinite;
}
#world-shift-effect .pixelate {
  position: absolute; inset: 0;
  background: repeating-linear-gradient(to right, rgba(255,255,255,0.05) 0px, rgba(0,0,0,0.05) 2px, transparent 4px);
  mix-blend-mode: overlay;
  animation: pixelFade 1.5s ease forwards;
}
@keyframes pixelShift {
  0% { opacity: 0; filter: none; }
  30% { opacity: 1; filter: contrast(200%) saturate(150%) hue-rotate(30deg); }
  70% { filter: blur(3px) contrast(300%) saturate(50%); }
  100% { opacity: 1; filter: blur(20px) brightness(0); }
}
@keyframes scan { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
@keyframes pixelFade { 0% { opacity: 0; } 100% { opacity: 1; } }
</style>
</head>
<body>
<div id="game-container">
  <div id="game-text"></div>
  <div id="choices"></div>
  <div id="action-buttons"></div>
  <div id="character"></div>
  <div id="background"></div>
</div>

<script>
const gameData = {
  scenes: {
    0: {
      texts: ["花井 葉 ：今日もバイト疲れたな、早く帰って寝よう", "花井 葉 ：今日は人通りも少ないな……"],
      next: 1,
      background: "scene_1.png"
    },
    1: {
      texts: ["花井 葉 ：貝殻のオルゴールだ…", "花井 葉 ：すごく綺麗だな、どこかで見た気がするけど…"],
      choices: [
        { text: "持って帰る", nextId: 3 },
        { text: "そのまま帰る", nextId: 2 }
      ],
      background: "scene_1.png"
    },
    2: {
      texts: ["花井 葉 ：明日もまた朝からバイトだなあ…"],
      background: "scene_1.png"
    },
    3: {
      texts: [
        "花井 葉 ：持って帰っちゃったけど、明日交番に持って行かなきゃ",
        "花井 葉 ：寝る前にもう一度聞いてみようかな"
      ],
      choices: [
        { text: "交番へ持っていく", nextId: 4 },
        { text: "自分のものにする", nextId: 5 }
      ],
      background: "scene_2.png"
    },
    4: {
      texts: ["花井 葉 ：交番に行こう…", "なんだか胸がざわつくな…"],
      next: 6,
      background: "scene_2.png",
      event: "goToAoHeya"
    },
    5: {
      texts: ["花井 葉 ：良い音色だなあ、どこかで聞いたことあるような…"],
      background: "scene_2.png",
      event: "goToHeya"
    },
    6: {
      texts: ["警察官：ありがとね、名前は？"],
      background: "scene_3.png",
      event: "nameInput"
    },
    7: {
      texts: ["花井 葉 ：落とし主が見つかるといいな…", "花井 葉 ：でも、どこかで見たことがあるんだけどな…"],
      background: "scene_3.png"
    },
    8: {
      texts: ["ユイ：藤沢くん、ありがとう", "ユイ：もう一度、会えると思ってた"],
      next: 9,
      background: "scene_4.png"
    },
    9: {
      texts: ["次作へ続く！！！"],
      background: "scene_4.png"
    }
  }
};

let currentSceneId = 0;
let currentTextIndex = 0;
let playerName = "";

function renderScene() {
  const scene = gameData.scenes[currentSceneId];
  const textEl = document.getElementById("game-text");
  const choicesEl = document.getElementById("choices");
  const actionEl = document.getElementById("action-buttons");
  const bgEl = document.getElementById("background");

  textEl.textContent = scene.texts[currentTextIndex];
  bgEl.style.backgroundImage = `url(${scene.background})`;
  choicesEl.innerHTML = "";
  actionEl.innerHTML = "";

  // 🔹 「次へ」ボタン（まだテキストが残っている場合）
  if (currentTextIndex < scene.texts.length - 1) {
    const nextBtn = document.createElement("button");
    nextBtn.textContent = "次へ";
    nextBtn.onclick = () => {
      currentTextIndex++;
      renderScene();
    };
    choicesEl.appendChild(nextBtn);
    return;
  }

  // 🔹 イベント処理
  if (scene.event) {
    if (scene.event === "nameInput") {
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "あなたの名前を入力";
      input.style.padding = "10px";
      input.style.fontSize = "1.2em";
      input.style.borderRadius = "8px";
      input.style.border = "2px solid #ccc";
      input.style.textAlign = "center";
      input.style.width = "70%";
      input.style.marginBottom = "10px";

      const btn = document.createElement("button");
      btn.textContent = "OK";
      btn.onclick = () => {
        const name = input.value.trim();
        if (!name) return alert("名前を入力してください。");
        playerName = name;
        currentSceneId = playerName === "ゆめのよう" ? 8 : 7;
        currentTextIndex = 0;
        renderScene();
      };
      choicesEl.append(input, btn);
      return;
    }

    // ✅ id4, id5 の専用ボタンは右上に配置
    if (scene.event === "goToAoHeya") {
      const btn = document.createElement("button");
      btn.textContent = "交番へ向かう ▶";
      btn.onclick = () => transitionTo("aoheya.html");
      actionEl.appendChild(btn);
    }

    if (scene.event === "goToHeya") {
      const btn = document.createElement("button");
      btn.textContent = "部屋へ戻る ▶";
      btn.onclick = () => transitionTo("heya.html");
      actionEl.appendChild(btn);
    }
  }

  // 🔹 選択肢がある場合
  if (scene.choices) {
    scene.choices.forEach(c => {
      const btn = document.createElement("button");
      btn.textContent = c.text;
      btn.onclick = () => {
        currentSceneId = c.nextId;
        currentTextIndex = 0;
        renderScene();
      };
      choicesEl.appendChild(btn);
    });
    return;
  }

  // 🔹 自動遷移
  if (scene.next !== undefined) {
    const btn = document.createElement("button");
    btn.textContent = "次へ";
    btn.onclick = () => {
      currentSceneId = scene.next;
      currentTextIndex = 0;
      renderScene();
    };
    choicesEl.appendChild(btn);
    return;
  }

  // 🔹 終了
  const endText = document.createElement("div");
  endText.textContent = "（クリックで最初に戻る）";
  endText.style.color = "#ccc";
  choicesEl.appendChild(endText);
  textEl.onclick = () => {
    currentSceneId = 0;
    currentTextIndex = 0;
    renderScene();
  };
}

// 🔸 エフェクト付きシーン遷移
function transitionTo(target) {
  const effect = document.createElement("div");
  effect.id = "world-shift-effect";
  effect.innerHTML = `<div class="scanline"></div><div class="pixelate"></div>`;
  document.body.appendChild(effect);
  setTimeout(() => (window.location.href = target), 1500);
}

renderScene();
</script>
</body>
</html>
