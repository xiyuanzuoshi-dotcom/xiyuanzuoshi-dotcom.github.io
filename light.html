<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>iOS-safe Pseudo Vibe — 擬似バイブ付き</title>
<style>
  :root{
    --bg:#071122; --card:#0b1622; --accent:#7ce7b3; --muted:#9fb0bd;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#031021,#051428);color:#eaf6f0;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box}
  .card{width:100%;max-width:760px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:16px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  h1{margin:0 0 6px;font-size:18px}
  p.lead{margin:0 0 14px;color:var(--muted);font-size:14px}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    background:linear-gradient(180deg,#0f2b34,#072025);border:1px solid rgba(255,255,255,0.04);
    padding:12px 16px;border-radius:10px;color:#dff6ec;font-weight:600;cursor:pointer;
    box-shadow: 0 6px 18px rgba(2,6,12,0.6);
    -webkit-tap-highlight-color:transparent;
  }
  .btn:active{transform:translateY(1px)}
  .big{
    margin-top:18px;width:100%;display:flex;align-items:center;justify-content:center;padding:22px;border-radius:14px;
    background:linear-gradient(180deg,#0a2a2b,#062026);font-size:20px;letter-spacing:1px;user-select:none;
  }
  .meta{margin-top:12px;color:var(--muted);font-size:13px}
  .toggle{display:inline-flex;align-items:center;gap:8px}
  .badge{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);font-size:13px;color:var(--muted)}
  /* shake animation (applied to .shake-on) */
  @keyframes shakeX {
    0%{transform:translateX(0)}
    10%{transform:translateX(-6px)}
    30%{transform:translateX(6px)}
    50%{transform:translateX(-4px)}
    70%{transform:translateX(4px)}
    90%{transform:translateX(-2px)}
    100%{transform:translateX(0)}
  }
  .shake-on{animation:shakeX 180ms linear 2}
  /* screen flash overlay */
  .screen-flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;transition:opacity .12s linear;z-index:9999}
  /* respects reduced motion */
  @media (prefers-reduced-motion: reduce){
    .shake-on{animation:none !important}
  }
  /* small footer */
  footer{margin-top:8px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="application" aria-label="Pseudo Vibe Playground">
    <h1>擬似バイブ（iOS向けフォールバック）</h1>
    <p class="lead">この端末が Vibration API に対応していないとき、自動的に「画面シェイク＋低音サウンド＋画面フラッシュ」でバイブ感を再現します。長押しで強めのパターン。</p>

    <div class="controls" aria-hidden="false">
      <button id="tapBtn" class="btn">タップでバイブ</button>
      <button id="longBtn" class="btn">長押し（強め）</button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <label class="toggle"><span class="badge" id="capBadge">判定中…</span></label>
      </div>
    </div>

    <div class="big" id="bigArea" tabindex="0" role="button" aria-pressed="false">TOUCH ME</div>

    <div class="meta">
      <div id="explain">検出：<span id="detectText">—</span></div>
      <div style="margin-top:6px" class="hint">※ 音は最初のユーザー操作で有効化されます（ブラウザ制約）。</div>
    </div>

    <footer>動作確認：Safari（iOS）ではハード振動は使えないため擬似バイブになります</footer>
  </div>
</div>

<div class="screen-flash" id="screenFlash" aria-hidden="true"></div>

<script>
/*
  Pseudo-vibration HTML
  - Auto-detect vibration support and iOS
  - If vibrate supported -> use navigator.vibrate
  - Else -> fakeVibration: low-frequency sound + screen shake + flash
  - Respects prefers-reduced-motion
*/

// helpers
const isIOS = (() => {
  // iPadOS with desktop UA also needs detection, so check platform & touch capability
  const ua = navigator.userAgent || navigator.vendor || '';
  // simple, robust check for iOS / iPadOS
  if (/iPad|iPhone|iPod/.test(ua)) return true;
  // iPadOS 13+ may show MacIntel
  if (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) return true;
  return false;
})();

const supportsVibrate = 'vibrate' in navigator && typeof navigator.vibrate === 'function';

// UI nodes
const tapBtn = document.getElementById('tapBtn');
const longBtn = document.getElementById('longBtn');
const bigArea = document.getElementById('bigArea');
const capBadge = document.getElementById('capBadge');
const detectText = document.getElementById('detectText');
const screenFlash = document.getElementById('screenFlash');

// motion preference
const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

// audio setup (lazy init per browser gesture)
let audioCtx = null;
function ensureAudio(){
  if(audioCtx) return audioCtx;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return audioCtx;
  }catch(e){
    audioCtx = null;
    return null;
  }
}

// low-frequency "thump" -> makes tactile impression
function playThump(duration = 0.08, freq = 120){
  const ctx = ensureAudio();
  if(!ctx) return;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = 'sine';
  o.frequency.value = freq;
  g.gain.value = 0.02; // keep it gentle
  o.connect(g); g.connect(ctx.destination);
  o.start();
  g.gain.setValueAtTime(0.02, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);
  o.stop(ctx.currentTime + duration + 0.02);
}

// short click sound (higher)
function playClick(duration = 0.06, freq = 700){
  const ctx = ensureAudio();
  if(!ctx) return;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = 'triangle';
  o.frequency.value = freq;
  g.gain.value = 0.012;
  o.connect(g); g.connect(ctx.destination);
  o.start();
  g.gain.setValueAtTime(0.012, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);
  o.stop(ctx.currentTime + duration + 0.02);
}

// fake vibration: combine audio + visual
function fakeVibration(totalMs = 160){
  // If user prefers reduced motion, only play sound (no shake/flash)
  playThump(0.10, 100);
  playClick(0.05, 1000);

  if(!reduceMotion){
    // apply shake class to bigArea for short time (prefers-reduced-motion will disable animation in CSS)
    bigArea.classList.add('shake-on');
    setTimeout(()=> bigArea.classList.remove('shake-on'), 400);
    // screen flash tiny
    screenFlash.style.opacity = 1;
    setTimeout(()=> screenFlash.style.opacity = 0, 140);
  }
}

// unified vibration function
function doVibrate(patternName = 'short', strong = false){
  const patterns = {
    short: [30],
    long: [120],
    pulse: [40, 50, 40],
    fun: [20,30,20,30,60]
  };
  const p = patterns[patternName] || patterns.short;

  if(supportsVibrate){
    try {
      // Choose stronger pattern for long press
      if(strong) navigator.vibrate([150,80,150]);
      else navigator.vibrate(p);
      // For browsers that silently accept but do nothing, fallback not trivial.
      return;
    } catch(e){
      // fall through to fake
    }
  }
  // fallback when no hardware vibrate
  // if strong, make it longer
  if(strong) fakeVibration(300);
  else fakeVibration(160);
}

// mark detection status
function updateDetectionBadge(){
  let txt = '';
  if(supportsVibrate) txt = 'Vibration API 支持あり';
  else txt = 'Vibration API 未対応（フォールバック）';
  if(isIOS) txt += ' — iOS 検出';
  detectText.textContent = txt;
  capBadge.textContent = supportsVibrate ? '振動可' : '擬似振動';
}

// handlers (ensure audio context created on first gesture)
function onUserGestureInit(){
  // create audio context on first user gesture to satisfy autoplay policies
  ensureAudio();
  // resume if suspended
  if(audioCtx && audioCtx.state === 'suspended'){
    audioCtx.resume().catch(()=>{});
  }
}

// wire buttons
tapBtn.addEventListener('click', (e) => {
  onUserGestureInit();
  doVibrate('short', false);
});
longBtn.addEventListener('mousedown', (e) => {
  // desktop long-press preview
});
longBtn.addEventListener('click', (e) => {
  onUserGestureInit();
  doVibrate('long', true);
});

// big area: support tap and long press on touch
let longTimer = null;
let pointerDownTime = 0;
bigArea.addEventListener('touchstart', (e) => {
  onUserGestureInit();
  pointerDownTime = Date.now();
  longTimer = setTimeout(()=> {
    doVibrate('fun', true);
    longTimer = null;
  }, 600); // long press threshold
}, {passive: true});
bigArea.addEventListener('touchend', (e) => {
  if(longTimer){ clearTimeout(longTimer); longTimer = null; doVibrate('short', false); }
});
bigArea.addEventListener('mousedown', (e) => {
  onUserGestureInit();
  pointerDownTime = Date.now();
  longTimer = setTimeout(()=> {
    doVibrate('fun', true);
    longTimer = null;
  }, 600);
});
bigArea.addEventListener('mouseup', (e) => {
  if(longTimer){ clearTimeout(longTimer); longTimer = null; doVibrate('short', false); }
});
bigArea.addEventListener('keydown', (e) => {
  if(e.key === ' ' || e.key === 'Enter'){
    onUserGestureInit();
    doVibrate('short', false);
  }
});

// init UI
updateDetectionBadge();

// safety: stop visual effects when page hidden
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    bigArea.classList.remove('shake-on');
    screenFlash.style.opacity = 0;
  }
});

// friendly hint: if user taps anywhere, ensure audio is ready
document.addEventListener('pointerdown', onUserGestureInit, {once:true});

</script>
</body>
</html>
