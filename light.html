<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ã´ãã´ããƒ©ã‚¤ãƒˆ â€” Vibe & Torch Playground</title>
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --accent:#00d4ff;
    --accent-2:#ff5ec4;
    --glass: rgba(255,255,255,0.06);
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN",sans-serif;color:#e6f0ff;background:
    radial-gradient(1200px 600px at 10% 10%, rgba(0,212,255,0.06), transparent),
    radial-gradient(1000px 500px at 90% 90%, rgba(255,94,196,0.04), transparent),
    var(--bg);
    -webkit-font-smoothing:antialiased}
  .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:18px}
  .card{width:100%;max-width:720px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:18px;padding:18px;box-shadow: 0 8px 30px rgba(2,6,23,0.6);backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.03)}
  header{display:flex;align-items:center;gap:12px}
  h1{font-size:18px;margin:0}
  p.lead{margin:6px 0 12px;color:#bcd9ff;font-size:13px}
  .controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .big-btn{
    -webkit-tap-highlight-color: transparent;
    user-select:none;
    touch-action:manipulation;
    width:160px;height:160px;border-radius:20px;display:flex;align-items:center;justify-content:center;flex-direction:column;
    font-weight:700;font-size:16px;color:#071126;background:linear-gradient(180deg,var(--accent),#00a8d9);
    box-shadow: 0 8px 20px rgba(0,212,255,0.12), inset 0 -6px 18px rgba(0,0,0,0.08);
    transition:transform .12s ease, box-shadow .12s ease;cursor:pointer;
  }
  .big-btn:active{transform:translateY(4px) scale(.99);box-shadow:0 4px 12px rgba(0,0,0,0.18)}
  .big-btn.secondary{background:linear-gradient(180deg,var(--accent-2),#ff4aa0);color:#071126}
  .small{padding:10px 12px;border-radius:12px;background:var(--glass);border:1px solid rgba(255,255,255,0.04);cursor:pointer}
  .toggles{display:flex;gap:10px;align-items:center;justify-content:center}
  .status{margin-top:12px;color:#9fbef7;font-size:13px;text-align:center}
  .flash-overlay{position:fixed;inset:0;pointer-events:none;background:yellow;opacity:0;transition:opacity .06s linear;mix-blend-mode:screen}
  .pulse{animation:pop .8s cubic-bezier(.2,.9,.3,1);transform-origin:center}
  @keyframes pop{0%{transform:scale(.9);opacity:0}50%{transform:scale(1.06);opacity:1}100%{transform:scale(1);opacity:1}}
  .hint{font-size:12px;color:#a6cfff;margin-top:8px;text-align:center}
  footer{margin-top:10px;text-align:center;color:#8fb8ff;font-size:12px}
  .credit{opacity:.7}
  /* playful icon */
  .icon{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .mode-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .row{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="application" aria-label="Vibe and Light Playground">
    <header>
      <div class="icon" aria-hidden="true">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v18M4 7v10M20 7v10" stroke="url(#g)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#00d4ff"/><stop offset="1" stop-color="#ff5ec4"/></linearGradient></defs></svg>
      </div>
      <div style="flex:1">
        <h1>ã´ãã´ããƒ©ã‚¤ãƒˆ â€” Vibe & Torch Playground</h1>
        <p class="lead">ã‚¹ã‚¤ãƒƒãƒã‚’ã‚¿ãƒƒãƒã—ã¦ãƒã‚¤ãƒ–ã¨ãƒ©ã‚¤ãƒˆã§éŠã¼ã†ã€‚ç«¯æœ«ã®æ¨©é™ãŒã‚ã‚Œã°ã‚«ãƒ¡ãƒ©ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆtorchï¼‰ã‚’æ“ä½œã—ã¾ã™ã€‚</p>
      </div>
    </header>

    <div class="controls" role="region" aria-label="Main controls">
      <button id="vibeBtn" class="big-btn" aria-pressed="false" aria-label="Vibrate">
        <div style="font-size:24px">ğŸ“³</div>
        <div style="font-size:13px;margin-top:6px">VIBRATE</div>
      </button>

      <button id="lightBtn" class="big-btn secondary" aria-pressed="false" aria-label="Toggle Light">
        <div style="font-size:26px">ğŸ”¦</div>
        <div style="font-size:13px;margin-top:6px">LIGHT</div>
      </button>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="mode-row">
        <button id="rhythm" class="small">ãƒªã‚ºãƒ ãƒ¢ãƒ¼ãƒ‰</button>
        <button id="strobe" class="small">ã‚¹ãƒˆãƒ­ãƒœï¼ˆãƒ©ã‚¤ãƒˆç‚¹æ»…ï¼‰</button>
        <button id="stopAll" class="small">å…¨éƒ¨æ­¢ã‚ã‚‹</button>
      </div>
    </div>

    <div class="status" id="status">æ©Ÿèƒ½æ¤œå‡ºä¸­â€¦</div>
    <div class="hint">â€» åˆå›ã§ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚è¨±å¯ã—ãªã„ã¨ãƒ©ã‚¤ãƒˆã¯ä½¿ãˆã¾ã›ã‚“ã€‚</div>
    <footer class="credit">by ã´ãã´ããƒãƒ¼ãƒ  â€” ã‚¹ãƒãƒ›ã§éŠã¼ã†ï¼</footer>
  </div>
</div>

<div class="flash-overlay" id="flashOverlay" aria-hidden="true"></div>

<script>
/* ---- ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼æ¤œå‡ºã¨çŠ¶æ…‹ç®¡ç† ---- */
const statusEl = document.getElementById('status');
const vibeBtn = document.getElementById('vibeBtn');
const lightBtn = document.getElementById('lightBtn');
const rhythmBtn = document.getElementById('rhythm');
const strobeBtn = document.getElementById('strobe');
const stopAllBtn = document.getElementById('stopAll');
const flashOverlay = document.getElementById('flashOverlay');

let supportsVibrate = 'vibrate' in navigator;
let supportsMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
let torchTrack = null;
let mediaStream = null;
let torchOn = false;
let strobeInterval = null;
let rhythmInterval = null;

/* å°ã•ãªã‚µã‚¦ãƒ³ãƒ‰åŠ¹æœï¼ˆãƒ‡ãƒ¼ã‚¿URIã®çŸ­ã„ãƒ“ãƒ¼ãƒ—ï¼‰ */
const beep = (() => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  return (freq=440, time=0.06, vol=0.06) => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + time);
  };
})();

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° */
function setStatus(text){
  statusEl.textContent = text;
}

/* åˆå›æ¤œå‡ºè¡¨ç¤º */
(async function init(){
  let msgs = [];
  msgs.push(supportsVibrate ? 'ãƒã‚¤ãƒ–å¯¾å¿œ âœ…' : 'ãƒã‚¤ãƒ–éå¯¾å¿œ âŒ');
  msgs.push(supportsMedia ? 'ã‚«ãƒ¡ãƒ©APIã‚ã‚Šï¼ˆãƒ©ã‚¤ãƒˆæ¤œå‡ºå¯èƒ½æ€§ã‚ã‚Šï¼‰' : 'ã‚«ãƒ¡ãƒ©APIãªã—ï¼ˆãƒ©ã‚¤ãƒˆä¸å¯ï¼‰');
  setStatus(msgs.join(' ãƒ» '));
})();

/* ---- ãƒã‚¤ãƒ–é–¢é€£ ---- */
function doVibrate(pattern){
  if(!supportsVibrate){
    setStatus('ã“ã®ç«¯æœ«ã¯Vibration APIæœªå¯¾å¿œã§ã™ã€‚');
    // ä»£æ›¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    animatePulse(vibeBtn);
    return;
  }
  // navigator.vibrateã¯æ•°å€¤ã¾ãŸã¯é…åˆ—ã‚’å—ã‘å–ã‚‹
  navigator.vibrate(pattern);
  animatePulse(vibeBtn);
  beep(620, 0.07, 0.045);
}

/* ---- ãƒ©ã‚¤ãƒˆï¼ˆtorchï¼‰é–¢é€£ ----
   å®Ÿè£…æ–¹é‡ï¼š
   - getUserMediaã§videoãƒˆãƒ©ãƒƒã‚¯ã‚’å–ã‚‹ï¼ˆãƒãƒƒã‚¯ã‚«ãƒ¡ãƒ©æ¨å¥¨ï¼‰
   - track.applyConstraints({advanced:[{torch:true}]}) ã‚’è©¦ã™
   - ä¸€éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã¯ ImageCapture ã‚’å¿…è¦ã¨ã™ã‚‹ãŸã‚ã€ä¸¡æ–¹è©¦ã™
*/
async function initTorchStream(){
  if(torchTrack) return; // æ—¢ã«å–å¾—æ¸ˆã¿
  if(!supportsMedia){ throw new Error('mediaDevices æœªå¯¾å¿œ'); }
  // ã‚«ãƒ¡ãƒ©ã¯ backï¼ˆç’°å¢ƒï¼‰ã‚’å„ªå…ˆã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  const constraints = {video:{facingMode:{ideal:'environment'}}};
  mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
  torchTrack = mediaStream.getVideoTracks()[0];
  // ä¸€éƒ¨ç«¯æœ«ã¯ ImageCapture å¿…è¦ã ãŒ applyConstraints ãŒåŠ¹ã‘ã°ok
  return torchTrack;
}

async function setTorch(on){
  try{
    if(on){
      if(!torchTrack){
        await initTorchStream();
      }
      // try applyConstraints first
      const capabilities = torchTrack.getCapabilities ? torchTrack.getCapabilities() : {};
      if(capabilities.torch || (capabilities.fillLightMode && capabilities.fillLightMode.length)){
        // ãƒ–ãƒ©ã‚¦ã‚¶ãŒtorchæ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã‚‹å¯èƒ½æ€§
        await torchTrack.applyConstraints({advanced:[{torch:true}]});
        torchOn = true;
        setStatus('ãƒ©ã‚¤ãƒˆï¼šON');
        beep(800,0.07,0.06);
        return true;
      } else {
        // è©¦ã—ã« ImageCapture ã‚’ä½¿ã£ã¦ torch ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹å®Ÿè£…
        // Some browsers (Chrome Android) allow applyConstraints even without capabilities listed, but others require ImageCapture.
        try{
          const ImageCapture = window.ImageCapture;
          if(ImageCapture){
            const ic = new ImageCapture(torchTrack);
            // no direct set torch via ImageCapture spec â€” but applyConstraints fallback often works
            await torchTrack.applyConstraints({advanced:[{torch:true}]});
            torchOn = true;
            setStatus('ãƒ©ã‚¤ãƒˆï¼šON');
            beep(800,0.07,0.06);
            return true;
          }
        }catch(e){ /* ignore */ }
      }
      // fallback: if none worked, emulate with screen flash
      screenFlash();
      setStatus('ãƒ©ã‚¤ãƒˆï¼šç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã§ä»£ç”¨ (torchæœªå¯¾å¿œ)');
      return false;
    } else {
      // turn off
      if(torchTrack){
        try{
          await torchTrack.applyConstraints({advanced:[{torch:false}]});
        }catch(e){ /* ignore */ }
        // stop stream to release camera
        try{
          mediaStream.getTracks().forEach(t=>t.stop());
        }catch(e){}
        torchTrack = null;
        mediaStream = null;
      }
      torchOn = false;
      setStatus('ãƒ©ã‚¤ãƒˆï¼šOFF');
      beep(420,0.05,0.04);
      return true;
    }
  }catch(err){
    // æ¨©é™æ‹’å¦ãªã©
    console.warn('torch error', err);
    setStatus('ãƒ©ã‚¤ãƒˆæ“ä½œã«å¤±æ•—: '+(err && err.message ? err.message : err));
    // fallback to screen flash to at least give something fun
    if(on) screenFlash();
    return false;
  }
}

function screenFlash(){
  flashOverlay.style.opacity = '1';
  setTimeout(()=>{ flashOverlay.style.opacity = '0'; }, 120);
}

/* ---- UIã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---- */
vibeBtn.addEventListener('click', async (ev)=>{
  ev.currentTarget.classList.add('pulse');
  setTimeout(()=>ev.currentTarget.classList.remove('pulse'), 800);
  // å˜ç™º + ãƒŸãƒ‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ¥½ã—ã
  doVibrate([40,30,60,20,40]);
});

lightBtn.addEventListener('click', async (ev)=>{
  ev.currentTarget.classList.add('pulse');
  setTimeout(()=>ev.currentTarget.classList.remove('pulse'), 800);
  lightBtn.disabled = true;
  try{
    if(!torchOn){
      const ok = await setTorch(true);
      if(!ok){
        // torch not supported â€” toggle an 'on-screen' style
        lightBtn.setAttribute('aria-pressed','true');
        lightBtn.style.boxShadow = '0 10px 30px rgba(255,200,80,0.12), inset 0 -6px 18px rgba(0,0,0,0.06)';
        setTimeout(()=>lightBtn.style.boxShadow='0 8px 20px rgba(0,212,255,0.12), inset 0 -6px 18px rgba(0,0,0,0.08)',600);
      } else {
        lightBtn.setAttribute('aria-pressed','true');
      }
    } else {
      await setTorch(false);
      lightBtn.setAttribute('aria-pressed','false');
    }
  }finally{
    lightBtn.disabled = false;
  }
});

/* ãƒªã‚ºãƒ ãƒ¢ãƒ¼ãƒ‰ï¼šé€£ç¶šã§çŸ­ã„ãƒã‚¤ãƒ–ã¨ãƒ©ã‚¤ãƒˆã‚’åŒæœŸ */
rhythmBtn.addEventListener('click', async ()=>{
  stopRhythm();
  setStatus('ãƒªã‚ºãƒ ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ ğŸµ');
  let beat = 0;
  rhythmInterval = setInterval(async ()=>{
    // simple 3-beat pattern
    const pattern = (beat % 3 === 0) ? [50] : [30];
    doVibrate(pattern);
    // small screen flash for visual
    flashOverlay.style.opacity = '0.9';
    setTimeout(()=>flashOverlay.style.opacity='0',80);
    beat++;
  }, 320);
});

/* ã‚¹ãƒˆãƒ­ãƒœãƒ¢ãƒ¼ãƒ‰ï¼šãƒ©ã‚¤ãƒˆç‚¹æ»…ã‚’è©¦ã™ï¼ˆtorchãŒãªã‘ã‚Œã°ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ */
strobeBtn.addEventListener('click', async ()=>{
  stopStrobe();
  setStatus('ã‚¹ãƒˆãƒ­ãƒœé–‹å§‹ âš¡');
  let on = false;
  strobeInterval = setInterval(async ()=>{
    on = !on;
    if(torchTrack || supportsMedia){
      // try to toggle torch; if unsupported, screenFlash will run
      await setTorch(on).catch(()=>screenFlash());
    } else {
      screenFlash();
    }
  }, 120);
});

/* å…¨åœæ­¢ */
stopAllBtn.addEventListener('click', ()=>{
  stopRhythm();
  stopStrobe();
  setTorch(false);
  navigator.vibrate(0); // stop vibration
  setStatus('ã™ã¹ã¦åœæ­¢ â€” ãŠã—ã¾ã„');
});

function stopRhythm(){
  if(rhythmInterval){ clearInterval(rhythmInterval); rhythmInterval = null; }
}
function stopStrobe(){
  if(strobeInterval){ clearInterval(strobeInterval); strobeInterval = null; }
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ»ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è£œåŠ© */
function animatePulse(el){
  el.classList.add('pulse');
  setTimeout(()=>el.classList.remove('pulse'),700);
}

/* ãƒšãƒ¼ã‚¸é›¢è„±ã§ã‚«ãƒ¡ãƒ©è§£æ”¾ */
window.addEventListener('pagehide', ()=>{
  if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
});

/* ä½™è«‡ï¼šé•·æŠ¼ã—ã§ãƒˆãƒªãƒƒã‚¯ï¼ˆãƒ‡ãƒ¢æ©Ÿèƒ½ï¼‰ */
vibeBtn.addEventListener('touchstart', (e)=>{
  // é•·æŠ¼ã—ã§å¼·æŒ¯å‹•ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é©šã‹ã›ãªã„ã‚ˆã†æ³¨æ„ã—ã¦çŸ­ãï¼‰
  e.currentTarget.vibeTimer = setTimeout(()=>doVibrate([120,40,120]),600);
});
vibeBtn.addEventListener('touchend', (e)=>{ clearTimeout(e.currentTarget.vibeTimer); });

/* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ã«ã‚¯ãƒªãƒƒã‚¯ã§ã®ãƒ’ãƒ³ãƒˆ */
if(!('ontouchstart' in window)){
  setStatus((statusEl.textContent||'') + ' â€” ã‚¿ãƒƒãƒã§ã‚ˆã‚Šæ¥½ã—ã„ã‚ˆï¼ˆã‚¹ãƒãƒ›æ¨å¥¨ï¼‰');
}

/* æ³¨æ„ï¼šä¸€éƒ¨æ©Ÿç¨®ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯torchåˆ¶å¾¡ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚
   ã‚‚ã—ãƒ©ã‚¤ãƒˆãŒONã«ãªã‚‰ãªã„å ´åˆã¯ã€ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãŒä»£ç”¨ã•ã‚Œã¾ã™ã€‚ */
</script>
</body>
</html>
