<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>3車線ドライブゲーム</title>
<style>
html,body { margin:0; padding:0; background:#111; overflow:hidden; color:#fff; font-family:sans-serif; }
#game { background:linear-gradient(#333,#000); display:block; margin:0 auto; }
#hud {
  position:absolute; top:10px; left:10px; z-index:10;
  background:rgba(0,0,0,0.4); padding:8px 12px; border-radius:8px;
}
#hud div { margin:4px 0; font-size:14px; }
#message {
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  font-size:24px; background:rgba(0,0,0,0.6); padding:16px 24px; border-radius:8px;
  display:none;
}
</style>
</head>
<body>
<canvas id="game" width="360" height="640"></canvas>
<div id="hud">
  <div>スコア: <span id="score">0</span></div>
  <div>距離: <span id="distance">0</span> m</div>
</div>
<div id="message">タップでスタート！</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const message = document.getElementById("message");
const scoreEl = document.getElementById("score");
const distanceEl = document.getElementById("distance");

const W = canvas.width;
const H = canvas.height;
const laneCount = 3;
const laneWidth = W / laneCount;
const roadSpeed = 6;

let player = { lane:1, y:H-100, width:laneWidth-20, height:80 };
let obstacles = [];
let distance = 0;
let score = 0;
let running = false;
let gameOver = false;

function startGame(){
  obstacles = [];
  distance = 0;
  score = 0;
  player.lane = 1;
  running = true;
  gameOver = false;
  message.style.display="none";
  loop();
}

function drawRoad(){
  ctx.fillStyle="#222";
  ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="#555";
  ctx.lineWidth=4;
  for(let i=1;i<laneCount;i++){
    ctx.beginPath();
    ctx.moveTo(i*laneWidth,0);
    ctx.lineTo(i*laneWidth,H);
    ctx.stroke();
  }
}

function drawPlayer(){
  ctx.fillStyle="#00ffaa";
  ctx.fillRect(player.lane*laneWidth+10-laneWidth, player.y, player.width, player.height);
}

function drawObstacles(){
  ctx.fillStyle="#ff3333";
  for(let o of obstacles){
    ctx.fillRect(o.lane*laneWidth+10-laneWidth, o.y, o.width, o.height);
  }
}

function update(){
  if(!running) return;
  distance += roadSpeed/5;
  distanceEl.innerText = Math.floor(distance);

  // 障害物生成
  if(Math.random()<0.02){
    const lane = Math.floor(Math.random()*laneCount);
    obstacles.push({
      lane:lane,
      y:-100,
      width:laneWidth-20,
      height:80
    });
  }

  // 障害物更新
  for(let o of obstacles){
    o.y += roadSpeed;
  }

  // 当たり判定
  for(let o of obstacles){
    if(o.lane===player.lane){
      if(o.y+o.height>player.y && o.y<player.y+player.height){
        running=false;
        gameOver=true;
        message.innerText="💥 GAME OVER 💥\nスコア:"+score+"\nタップでリトライ";
        message.style.display="block";
      }
    }
  }

  // 通過済み削除＆スコア加算
  obstacles = obstacles.filter(o=>{
    if(o.y>H){
      score++;
      scoreEl.innerText=score;
      return false;
    }
    return true;
  });
}

function draw(){
  ctx.clearRect(0,0,W,H);
  drawRoad();
  drawPlayer();
  drawObstacles();
}

function loop(){
  if(!running) return;
  update();
  draw();
  requestAnimationFrame(loop);
}

// スマホ傾き or キーボード入力
window.addEventListener("deviceorientation", e=>{
  if(!running) return;
  if(e.gamma > 15) player.lane = Math.min(player.lane+1, laneCount-1);
  if(e.gamma < -15) player.lane = Math.max(player.lane-1, 0);
});

window.addEventListener("keydown", e=>{
  if(!running) return;
  if(e.key==="ArrowLeft") player.lane=Math.max(player.lane-1,0);
  if(e.key==="ArrowRight") player.lane=Math.min(player.lane+1,laneCount-1);
});

// タップで開始/リトライ
canvas.addEventListener("click", ()=>{
  if(!running || gameOver) startGame();
});

// 初期メッセージ
message.innerText="🚗 タップでスタート 🚗";
message.style.display="block";
</script>
</body>
</html>
